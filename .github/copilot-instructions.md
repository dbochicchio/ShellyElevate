# ShellyElevate AI Guide

This app is designed for the Shelly Wall Display family to provide full dashboard functionality via an injected web app. Below is a technical overview of the app's architecture and key components.

- Core flow: [ShellyElevateApplication.java](app/src/main/java/me/rapierxbox/shellyelevatev2/ShellyElevateApplication.java) boots global singletons (DeviceHelper, DeviceSensorManager, ScreenManager, ScreenSaverManager, SwipeHelper, MediaHelper, HttpServer, MQTTServer, ShellyElevateJavascriptInterface) and keeps the NanoHTTPD server alive when enabled.
- Main UI: [MainActivity.kt](app/src/main/java/me/rapierxbox/shellyelevatev2/MainActivity.kt) is a full-screen WebView shell that loads the Home Assistant URL from shared prefs (see ServiceHelper.getWebviewUrl), shows offline.html when network/SSL fails, and listens to LocalBroadcastManager intents for settings reload, JS injection, screen state, and proximity events.
- Hidden settings affordance: ten taps on both left and right overlays triggers [SettingsActivity](app/src/main/java/me/rapierxbox/shellyelevatev2/SettingsActivity.kt); the activity is auto-opened on first run when SP_SETTINGS_EVER_SHOWN is false.
- Lifecycle helpers: [KioskService.java](app/src/main/java/me/rapierxbox/shellyelevatev2/KioskService.java) runs as a foreground watchdog that relaunches MainActivity if it dies; [BootReceiver.java](app/src/main/java/me/rapierxbox/shellyelevatev2/BootReceiver.java) starts the kiosk service on boot and skips MainActivity when lite mode is enabled; [CrashHandler.kt](app/src/main/java/me/rapierxbox/shellyelevatev2/CrashHandler.kt) logs to filesDir/crash_log.txt and restarts after a crash.
- Settings persistence: all configuration lives in the shared prefs named ShellyElevateV2; keys are in [Constants.java](app/src/main/java/me/rapierxbox/shellyelevatev2/Constants.java). [SettingsFragment.kt](app/src/main/java/me/rapierxbox/shellyelevatev2/SettingsFragment.kt) drives the UI, saves onPause, and broadcasts INTENT_SETTINGS_CHANGED so consumers reload.
- Networking discovery: [ServiceHelper.java](app/src/main/java/me/rapierxbox/shellyelevatev2/helper/ServiceHelper.java) can discover Home Assistant via mDNS (_home-assistant._tcp) and exposes isNetworkReady for connectivity checks before loading the WebView.
- WebView bridge: [ShellyElevateJavascriptInterface.java](app/src/main/java/me/rapierxbox/shellyelevatev2/ShellyElevateJavascriptInterface.java) exposes relays, sensors, brightness, and screensaver control to JS; extended interface use is gated by SP_EXTENDED_JAVASCRIPT_INTERFACE. JS events are relayed by broadcasting INTENT_WEBVIEW_INJECT_JAVASCRIPT.
- Screen and sensors: [DeviceSensorManager.java](app/src/main/java/me/rapierxbox/shellyelevatev2/helper/DeviceSensorManager.java) listens for light/proximity sensors and broadcasts INTENT_LIGHT_UPDATED / INTENT_PROXIMITY_UPDATED; [ScreenManager.java](app/src/main/java/me/rapierxbox/shellyelevatev2/helper/ScreenManager.java) applies hysteresis-based brightness (auto or fixed), honors screensaver state, and forces brightness to 0 when the screen is off.
- Screensavers: [ScreenSaverManager.java](app/src/main/java/me/rapierxbox/shellyelevatev2/screensavers/ScreenSaverManager.java) tracks idle time, proximity wake, and start/stop broadcasts (INTENT_SCREEN_SAVER_STARTED/STOPPED). Available savers live in screensavers/; add new ones by extending ScreenSaver and wiring into getAvailableScreenSavers.
- Device IO: [DeviceHelper.java](app/src/main/java/me/rapierxbox/shellyelevatev2/helper/DeviceHelper.java) touches sysfs for relays and brightness and reads temp/humidity from /sys/devices/platform/sht3x-user/sht3x_access; only adjust paths if you know the target hardware.
- Input handling: [SwipeHelper.java](app/src/main/java/me/rapierxbox/shellyelevatev2/helper/SwipeHelper.java) toggles relay 0 and publishes swipe MQTT events on fast vertical swipes when SP_SWITCH_ON_SWIPE is true; MainActivity maps hardware keycodes (140–142, 131–136) to MQTT/button events and screen actions.
- Media: [MediaHelper.java](app/src/main/java/me/rapierxbox/shellyelevatev2/helper/MediaHelper.java) manages separate players for music/effects; it is no-op unless SP_MEDIA_ENABLED is set. Volume is normalized 0–1 and persisted via the Android stream volume.
- HTTP API: [HttpServer.java](app/src/main/java/me/rapierxbox/shellyelevatev2/HttpServer.java) runs on port 8080 (guarded by SP_HTTP_SERVER_ENABLED) and exposes /settings (get/set prefs), /device (relay/temp/hum/lux/proximity/wake/sleep/reboot), /media (play/pause/resume/stop/volume), and /webview (refresh/inject JS) endpoints. Settings changes broadcast INTENT_SETTINGS_CHANGED.
When implementing new settings, please ensure those are mapped in then HTTP endpoints related to the settings. Please always align to UI, so everythng exposed here is always up-to-date in API and vice versa.
- MQTT: [MQTTServer.java](app/src/main/java/me/rapierxbox/shellyelevatev2/mqtt/MQTTServer.java) uses Eclipse Paho v5; it connects only when SP_MQTT_ENABLED and broker/user/pass/port are set, publishes HA auto-discovery config, and keeps temp/hum/lux/brightness/proximity/switch status updated. Incoming topics are handled in [ShellyElevateMQTTCallback.java](app/src/main/java/me/rapierxbox/shellyelevatev2/mqtt/ShellyElevateMQTTCallback.java) for relay commands, sleep/wake/reboot, and WebView refresh.
- Gesture for screensaver keep-alive: UserInteractionReceiver listens for ACTION_USER_INTERACTION broadcasts to reset idle timers by delegating to ScreenSaverManager.
- Device models: [DeviceModel.java](app/src/main/java/me/rapierxbox/shellyelevatev2/DeviceModel.java) encodes hardware capabilities (proximity, offsets, button/input counts) and determines behavior across helpers; prefer using DeviceModel.getReportedDevice instead of hardcoding model names.
- Build/testing: Android app module uses Gradle wrapper; run ./gradlew assembleDebug or ./gradlew installDebug on a rooted Shelly Wall Display (minSdk 24, compileSdk 35, targetSdk 24). No automated tests exist; manual verification happens on device via the WebView shell and HTTP/MQTT endpoints.
- Common comms pattern: cross-component events rely on LocalBroadcastManager; when adding new behaviors, broadcast intents from the Constants catalog and register receivers in onCreate/onDestroy to avoid leaks.
- When extending prefs or remote controls, update Constants for keys/topics, persist via SharedPreferences (SettingsFragment and SettingsParser), and ensure MQTT/HTTP/WebView bridges stay in sync.

## Further notes
- The app assumes root access for sysfs IO; ensure the target device is rooted and paths in DeviceHelper are correct.
- Screensaver implementations should be efficient to avoid battery drain; prefer lightweight operations in onUpdate.
- When modifying brightness handling, consider user experience around auto-brightness and screensaver interactions to prevent jarring transitions.
- MQTT topics follow a structured format based on device model and ID; maintain consistency when adding new topics or payloads.
- Performance optimizations may be necessary for older hardware; profile sensor polling and WebView interactions if latency issues arise.